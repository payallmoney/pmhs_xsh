<!DOCTYPE html>  
<html>  
<head>  
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />  
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />  
<link rel="stylesheet" type="text/css" href="../themes/sunny/easyui.css">
<link rel="stylesheet" type="text/css" href="../themes/icon.css">
<script type="text/javascript" src="../js/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="../js/jquery.easyui.min.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.5&ak=10fd14046e11c2285e97009ff7cc6a0f"></script>
<script type="text/javascript" src="BMapLib_AreaRestriction.js"></script>
<script type="text/javascript" src="MarkerTool.js"></script>

<script type='text/javascript' src='/dwr/engine.js'></script>
<script type='text/javascript' src='/dwr/interface/MapService.js'></script>


<title>地图展示信息</title>  
<style type="text/css">  
html{height:100%}  
body{height:100%;margin:0px;padding:0px}  
#container{height:100%}  
a.theforever_knight1:visited {color:orange;}
#l-map{height:100%;width:78%;float:left;border-right:2px solid #bcbcbc;}
</style>  

<script type="text/javascript">

var html = [];
html.push('<span style="font-size:12px">卫生组织机构信息: </span><br/>');
html.push('<table border="0" cellpadding="1" cellspacing="1" >');
html.push('  <tr>'); 
html.push('      <td align="left" class="common">组织机构选择：</td>');
html.push('      <td colspan="1"><input type="button" name="btnOK"  onclick="openTreeOrgan()" value="组织机构选择"></td>');
html.push('  </tr>');
html.push('  <tr>'); 
html.push('      <td align="left" class="common">组织机构代码：</td>');
html.push('      <td colspan="1"><input type="text" maxlength="50" size="18" id="organId" readonly="true"></td>');
html.push('  </tr>');
html.push('  <tr>');
html.push('      <td  align="left" class="common">组织机构名称：</td>');
html.push('      <td colspan="1"><input type="text" maxlength="30" size="18" id="organName" readonly="true></td>');
html.push('  </tr>');
html.push('  <tr>');
html.push('	     <td  align="center" colspan="2">');
html.push('          <input type="button" name="btnOK"  onclick="fnOK()" value="保存">&nbsp;&nbsp;');
html.push('		     <input type="button" name="btnClear" onclick="fnClear()" value="删除">');
html.push('	     </td>');
html.push('  </tr>');
html.push('</table>');	

var infoWin = new BMap.InfoWindow(html.join(""), {offset: new BMap.Size(0, -10)});

$(function(){


	MapService.queryPointer(function(data){
		if(data == null){
			alert("null");
			return;
		}else{

			$.each(data, function(i, n){
				var lng = parseFloat(n.id.split(",")[0]);
				var lat = parseFloat(n.id.split(",")[1]);
				var pt = new BMap.Point(lng,lat);
				var maker = new BMap.Marker(pt);
				map.addOverlay(maker);    

				maker.addEventListener("click", function(){
					var id = this.getPosition().lng + "," + this.getPosition().lat;
					alert(id);
					MapService.queryPointerById(id,function(data){
						//var mkr = evt.marker;
						maker.openInfoWindow(infoWin);
						document.getElementById("organId").value = data.organId;
						document.getElementById("organName").value = data.organName;

						//alert(JSON.stringify(data));
					});
					
				});

			});


		}

	});

		$('#treeOrganizationId').bind('click', function(){  
			$('#organizationinfo').dialog('open'); 
			/*
			$('#taxinfo').panel('move',{   
			  left:13,   
			  top:50   
			});
			*/
		}); 
	

		$('#organizationTree').tree({   
			 checkbox: false,   
			 url: '/OrganizationTreeServlet?type=1&pid=0&levels=top',   
			 onBeforeExpand:function(node,param){  
				 $('#organizationTree').tree('options').url = "/OrganizationTreeServlet?type=1&pid="+node.id+"&levels=" + node.attributes.levels;
				 //alert(node.id);
			 },               
			onClick:function(node){

				document.getElementById("xzqNameId").value = node.text;
				document.getElementById("xzqCodeId").value = node.id;
				//alert(node.text + "---" + node.id);


 
			},
			onDblClick:function(node){
				//alert(node.id);
				var node1 = $('#taxtree').tree('getSelected');
				$('#organizationTree').tree('options').url = "/OrganizationTreeServlet?type=1&pid="+node.id+"&levels=" + node.attributes.levels;
				$('#taxtree').tree('expand', node1.target); 
			},
			onExpand:function(node, data){

				//alert(JSON.stringify(node));
				//var node = $('#taxtree').tree('getSelected');
				//$('#taxtree').tree('expand', node.target); 
			}
			 

		});	
		$('#saveId').bind('click', function(){
			var xzqCode = document.getElementById("xzqCodeId").value;
			var sw_x = document.getElementById("sw_xId").value;
			var sw_y = document.getElementById("sw_yId").value;
			var ne_x = document.getElementById("ne_xId").value;
			var ne_y = document.getElementById("ne_yId").value;
			var center_x = document.getElementById("center_xId").value;
			var center_y = document.getElementById("center_yId").value;
			var zoom_level = document.getElementById("zoom_levelId").value;
			MapService.saveAreaRestrictConfig(xzqCode,sw_x,sw_y,ne_x,ne_y,center_x,center_y,zoom_level,function(d){
				alert("配置保存成功");



			});


		}); 	
})
</script>

</head>  
   
<body style="overflow:hidden">  


	<div class="easyui-layout" style="width:1100px;height:650px;">

	

	

		<div data-options="region:'center',iconCls:'icon-ok'" style="width:750px;border:1">
			<div id="container">

			
			</div>
		</div>

		<div data-options="region:'east',split:true,title:'地图区域配置',border:true" style="width:350px;">

				<a href="#" id="treeOrganizationId" class="easyui-linkbutton" data-options="plain:false,iconCls:'icon-position'">地图定位</a>

				<br><br>
				<table border="0">
					<tr>
						<td>
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;行政区域名称：
						</td>
						<td>
							<input id="xzqNameId" type="text" value=""/>
						 
						</td>

					</tr>
					<tr>
						<td>
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;行政区域代码：
						</td>
						<td>
							<input id="xzqCodeId" type="text" value=""/>
						 
						</td>

					</tr>

				</table>

				<br>
				<table border="0">
					<tr>
						<td>
							&nbsp;&nbsp;&nbsp;&nbsp;<input id="swPointCheckboxId" type="checkbox"/>&nbsp;&nbsp;西南限制点X：
						</td>
						<td>
							<input id="sw_xId" type="text" value=""/>
						 
						</td>

					</tr>
					<tr>
						<td>
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;西南限制点Y：
						</td>
						<td>
							<input id="sw_yId" type="text" value=""/>
						 
						</td>

					</tr>

				</table>
	

				<br>
				<table border="0">

					<tr>
						<td>
							&nbsp;&nbsp;&nbsp;&nbsp;<input id="nePointCheckboxId" type="checkbox"/>&nbsp;&nbsp;东北限制点X：
						</td>
						<td>
							<input id="ne_xId" type="text" value=""/>
						 
						</td>

					</tr>
					<tr>
						<td>
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;东北限制点Y：
						</td>
						<td>
							<input id="ne_yId" type="text" value=""/>
						 
						</td>

					</tr>
				</table>

	

				<br>
				<table border="0">

					<tr>
						<td>
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;中心定位点X：
						</td>
						<td>
							<input id="center_xId" type="text" value=""/>
						 
						</td>

					</tr>
					<tr>
						<td>
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;中心定位点Y：
						</td>
						<td>
							<input id="center_yId" type="text" value=""/>
						 
						</td>

					</tr>
				</table>

				<br>
				<table border="0">

					<tr>
						<td>
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;地图缩放级别：
						</td>
						<td>
							<input id="zoom_levelId" type="text" value=""/>
						 
						</td>

					</tr>
				</table>

				<br>
				<table border="0">

					<tr>
						<td>
							&nbsp;
						</td>
						<td>
							<a href="#" id="saveId" class="easyui-linkbutton" data-options="plain:false,iconCls:'icon-position'">保存</a>

						 
						</td>

					</tr>
				</table>

		</div>

</div>




<script>

	var map = new BMap.Map("container");
	map.centerAndZoom("昆明", 16);
	map.enableScrollWheelZoom(); 
	map.addEventListener("click", function(e){
		if(document.getElementById("swPointCheckboxId").checked){
				document.getElementById("sw_xId").value = e.point.lng;
				document.getElementById("sw_yId").value = e.point.lat;
		}
		if(document.getElementById("nePointCheckboxId").checked){
				document.getElementById("ne_xId").value = e.point.lng;
				document.getElementById("ne_yId").value = e.point.lat;
		}
	});

	map.addEventListener("dragend", function showInfo(){
		var cp = map.getCenter();
		document.getElementById("center_xId").value = cp.lng;
		document.getElementById("center_yId").value = cp.lat;
	});
	map.addEventListener("zoomend", function showInfo(){
		document.getElementById("zoom_levelId").value = map.getZoom();
	});

</script>


<script>

</script>

		<div id="organizationinfo" class="easyui-dialog" title="&nbsp;" data-options="iconCls:'icon-save',closed:true,modal:false,collapsible:true"  style="width:300px;height:500px;">
			
			<div id="organizationLayout" class="easyui-layout" style="width:280px;height:500px;" data-options="fit:true">
				<div data-options="region:'center',split:true" title="">
					<ul id="organizationTree" data-options="animate:true"></ul>
				</div>
			</div>
		</div>

</body>  

</html>  
